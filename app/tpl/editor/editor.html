<!DOCTYPE html>
<html>

<head>
    <!-- <link href="/node_modules/ace-builds/css/ace.css" rel="stylesheet"> -->
    <!-- <script src="/node_modules/ace-builds/src-min/ace.js"></script> -->
    <!-- <script src="/node_modules/ace-builds/src-min/theme-chrome.js"></script> -->
    <title>Wilda - configuration page</title>

    <script>{ GLOBAL_CONFIG }</script>
    <script src="/node_modules/zepto/dist/zepto.min.js"></script>

    <script src="/node_modules/ajv/dist/ajv.min.js"></script>

    <script src="/node_modules/bootstrap/dist/js/bootstrap.min.js"></script>
    <link href="/node_modules/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">

    <script src="/node_modules/jsoneditor/dist/jsoneditor.min.js"></script>
    <link href="/node_modules/jsoneditor/dist/jsoneditor.min.css" rel="stylesheet">
    <link href="/app/tpl/editor/editor.css" rel="stylesheet">
    <!-- <link href="/node_modules/jsoneditor/examples/css/darktheme.css" rel="stylesheet"> -->
</head>

<body>
    <header>
        <div class="container jumbotron">
            <div class="row py-3">
                <div class="col-auto">
                    <h1>Wilda - configuration</h1>
                </div>
                <div class="col-auto">
                    <div class="badge bg-secondary" id="version"></div>
                </div>
            </div>
            <div class="revision-wrapper">
                <div class="row row-cols-auto">
                    <div class="col">
                        <button class="btn btn-primary position-relative" id="revision-restore">Восстановить <span
                                class="badge position-absolute top-0 start-100 translate-middle rounded-pill bg-danger"
                                id="revision-counts"></span>
                        </button>
                    </div>
                    <div class="col">
                        <button class="btn btn-primary" disabled id="revision-save">Сохранить</button>
                    </div>
                </div>
            </div>
        </div>
    </header>
    <main role="main">
        <div class="py-3 container">
            <div id="jsoneditor"></div>
        </div>
    </main>

    <script>
        var buttonSaveTrigger = false;
        const revision = {};
        const container = document.getElementById("jsoneditor")
        
        const hostSchemaRefs = {

        };

        const options = {
            name: 'hosts',
            mode: 'tree',
            // modes: ['code', 'tree'],
            // ace: ace,
            history: true,
            enableSort: false,
            enableTransform: false,
            limitDragging: true,
            /* ajv: Ajv({
                allErrors: true,
                verbose: true,
                jsonPointers: true,
                $data: true
            }), */
            schema: {
                "type": "array",
                "items": {
                    "type": "object",
                    "properties": {
                        "type": {
                            "title": "Тип сайта",
                            "enum": ["Tilda", "Wix", "Plain"],
                            "type": "string"
                        },
                        "site": {
                            "type": "array",
                            "items": {
                                "type": "string"
                            }
                        },
                        "project": {
                            "type": "string"
                        },
                        "privoxy": {
                            "type": "object",
                            "properties": {
                                "enabled": {
                                    "type": "boolean",
                                    "default": true
                                }
                            }
                        },
                        "mail": {
                            "type": "object",
                            "properties": {
                                "enabled": {
                                    "type": "boolean",
                                    "default": true
                                },
                                "subject": {
                                    "type": "string"
                                },
                                "name": {
                                    "type": "string"
                                },
                                "from": {
                                    "type": "string"
                                },
                                "success": {
                                    "type": "string"
                                },
                                "error": {
                                    "type": "string"
                                },
                                "to": {
                                    "type": "array",
                                    "items": {
                                        "type": "string"
                                    }
                                }
                            }
                        },
                        "favicon": {
                            "type": "object",
                            "properties": {
                                "enabled": {
                                    "type": "boolean",
                                    "default": true
                                }
                            }
                        },
                        "cache": {
                            "type": "object",
                            "properties": {
                                "enabled": {
                                    "type": "boolean",
                                    "default": true
                                },
                                "stats": {
                                    "type": "boolean",
                                    "default": true
                                },
                                "expire": {
                                    "type": "number",
                                    "default": 86400
                                }
                            }
                        },
                        "inject": {
                            "type": "object",
                            "properties": {
                                "enabled": {
                                    "type": "boolean",
                                    "default": true
                                },
                                "header": {
                                    "type": "boolean",
                                    "default": true
                                },
                                "footer": {
                                    "type": "boolean",
                                    "default": true
                                }
                            }
                        },
                        "metrics": {
                            "type": "object",
                            "properties": {
                                "enabled": {
                                    "type": "boolean",
                                    "default": true
                                },
                                "ya": {
                                    "type": "string"
                                },
                                "ga": {
                                    "type": "string"
                                }
                            }
                        },

                    },
                    "required": [ "type", "site", "project" ]
                }
            },
            templates: [
                {
                    text: 'Новый сайт',
                    title: 'Добавить новый сайт',
                    className: 'jsoneditor-type-object',
                    field: '',
                    value: GLOBAL_CONFIG.hosts[0]
                },
                {
                    text: 'Почта',
                    title: 'Добавить почту',
                    className: 'jsoneditor-type-object',
                    field: 'mail',
                    value: GLOBAL_CONFIG.mail
                },
                {
                    text: 'Инжектор HTML',
                    title: 'Добавить HTML',
                    className: 'jsoneditor-type-object',
                    field: 'inject',
                    value: GLOBAL_CONFIG.inject
                },
                {
                    text: 'Метрика',
                    title: 'Добавить метрику (Yandex, Google)',
                    className: 'jsoneditor-type-object',
                    field: 'metrics',
                    value: GLOBAL_CONFIG.metrics
                },
                {
                    text: 'Фавикон',
                    title: 'Добавить иконку сайта',
                    className: 'jsoneditor-type-object',
                    field: 'favicon',
                    value: GLOBAL_CONFIG.favicon
                },
                {
                    text: 'Кэширование',
                    title: 'Добавить кэширование',
                    className: 'jsoneditor-type-object',
                    field: 'cache',
                    value: GLOBAL_CONFIG.cache
                }
            ],
            onChange: function () {
                if (!buttonSaveTrigger) {
                    buttonSaveTrigger = true;
                    $('#revision-save').removeAttr('disabled');
                    $('#revision-restore').removeAttr('disabled');
                }
            },
            onCreateMenu: function (items, node) {
                const path = node.path

                // console.log('items:', items, 'node:', node)

                items.forEach(function (item, index, items) {
                    if ("submenu" in item) {

                        items[index].submenu = items[index].submenu.filter(function (item) {
                            return item.type !== 'separator'
                        })

                        if (items[index].text == 'Insert')
                            items[index].text = 'Добавить';

                        switch (node.path.length) {
                            case 1:
                                items[index].submenu = items[index].submenu.filter(function (item) {
                                    var excludes = ['Новый сайт'];
                                    return excludes.includes(item.text);
                                })


                                break;

                            case 2:
                                items[index].submenu = items[index].submenu.filter(function (item) {
                                    var excludes = ['Auto', 'Array', 'Object', 'String', 'Новый сайт'];
                                    return !excludes.includes(item.text);
                                })

                                break;

                            default:
                                break;
                        }
                    }

                    /*                         items[index].className += ' submenu-highlight'
                                        } else {
                                            // if it's not a submenu heading, let's make it colorful
                                            items[index].className += ' rainbow'
                                        } */
                })

                items = items.filter(function (item) {
                    return item.type !== 'separator'
                })


                items = items.filter(function (item) {
                    var excludes = ['Type', 'Extract'];
                    return !excludes.includes(item.text);
                })

                return items
            }
        };

        const editor = new JSONEditor(container, options)
        var setUserConfig = function (success, beforesend, post) {
            beforesend();
            var xhr = ("onload" in new XMLHttpRequest()) ? new XMLHttpRequest() : new XDomainRequest();

            xhr.open('POST', '/?editor', true);
            xhr.setRequestHeader("Content-Type", "application/json");
            xhr.onload = success;
            return xhr.send(JSON.stringify(post));
        };

        var setUserConfigRevisions = function (revisions) {
            var elems = [];
            /*                 for (let index = 0; index < revisions.length; index++) {
                                const rev = revisions[index];
                                // console.log(rev);
                                elems.push('<li>' + rev + '</li>');
                            } */

            revision.all = revisions;
            revision.prev = revisions[(revisions.length - 1)];
            $('#revision-counts').html(revisions.length);

            /*                 $('<ul/>', {
                                id: 'revision-menu',
                                html: elems.join(' ')
                            }).appendTo('#revision-status'); */
        }


        setUserConfig((d) => {
            var data = JSON.parse(d.target.responseText);
            setUserConfigRevisions(data.revisions);
            editor.set(data.hosts);
            editor.expandAll();
        }, () => { }, {
            config: true
        });

        $('#revision-save').click(() => {
            setUserConfig((d) => {
                var data = JSON.parse(d.target.responseText);

                if (data.status) {
                    $('#revision-save').attr('disabled', '');
                    // $('#revision-restore').attr('disabled', '');

                    buttonSaveTrigger = false;
                    var revCounts = (parseInt($('#revision-counts').text()) + 1);
                    $('#revision-counts').text(revCounts);
                }

            }, () => { }, {
                save: true,
                data: editor.getText()
            });
        });

        $('#revision-restore').click(() => {
            // console.log(revision.prev);
            setUserConfig((d) => {
                var data = JSON.parse(d.target.responseText);

                console.log('restored revision');
                // console.log(data);

                setUserConfig((d) => {
                    var data = JSON.parse(d.target.responseText);
                    setUserConfigRevisions(data.revisions);
                    editor.set(data.hosts);
                    editor.expandAll();
                }, () => { }, {
                    config: true
                });

            }, () => { }, {
                config: true,
                revision: revision.prev
            });
        });

        $('#version').text(
            'ver: ' + GLOBAL_CONFIG.version + ', ' + GLOBAL_CONFIG.version_date
        );

    </script>
</body>

</html>